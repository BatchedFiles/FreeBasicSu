<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN" "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd"[

	<!ENTITY nbsp "&#160;">
	<!ENTITY t "&#160;&#160;&#160;&#160;">
	
]>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/1999/xhtml http://www.w3.org/MarkUp/SCHEMA/xhtml11.xsd" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

<head>
	<title>Файлы инициализации</title>
	<meta name="description" content="Чтение и запись файлов конфигурации — INI‐файлов — функциями GetPrivateProfileString и WritePrivateProfileString, получение всех секций и параметров в секции." />
	<meta name="keywords" content="GetPrivateProfileString, WritePrivateProfileString, FreeBASIC, WinAPI, INI, программирование" />
	
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="/styles.css" type="text/css" rel="stylesheet" />
	
</head>

<body>

<header>
	
	<nav>
		<a href="/">Главная</a>
		<a href="/src/">Статьи</a>
		<a href="/code/">Проекты</a>
		<a href="/books/">Учебник</a>
		<a href="/links.xhtml">Ссылки</a>
		<a href="/about.xhtml">О сайте</a>
	</nav>
	
</header>


<h1>Файлы инициализации</h1>

<main>
	<p class="postername">
		<a href="/users/mabu.xhtml">
			<img src="/avatars/mabu.jpg" alt="Аватар пользователя" width="50" height="50" class="avatar" />
			&#32;
			mabu
		</a>
		&#32;
		<time pubdate="pubdate">2016-02-10T09:25:31+07:00</time>
	</p>

	<p>Практически любое программное обеспечение способно запоминать (сохранять) настройки, установленные пользователем. Например, внешний вид окна, язык, имя пользователя. В простых программах проще всего использовать файлы инициализации.</p>

	<ol class="contents">
		<li><a href="#c1">Формат файла</a></li>
		<li><a href="#c2">Функции для работы с ini‐файлами</a>
			<ol>
				<li><a href="#c2c1">GetPrivateProfileString</a></li>
				<li><a href="#c2c2">GetPrivateProfileInt</a></li>
				<li><a href="#c2c3">WritePrivateProfileString</a></li>
			</ol>
		</li>
		<li><a href="#c3">Примеры</a>
			<ol>
				<li><a href="#c3c1">Чтение файла</a></li>
				<li><a href="#c3c2">Получение всех секций и ключей</a></li>
				<li><a href="#c3c3">Запись в файл</a></li>
				<li><a href="#c3c4">Удаление раздела или параметра</a></li>
			</ol>
		</li>
		<li><a href="#c4">Ссылки</a></li>
	</ol>


	<h2><a id="c1">Формат файла</a></h2>

	<p>Файлы с расширением *.ini широко распространены не только в мире Windows, но и в других системах, например, php.ini. Формат ini‐файла очень прост: файл разделён на секции (или разделы), в каждой секции может находиться произвольное число записей вида «параметр=значение». Секции указываются в квадратных скобках. Имена параметров в разных секциях могут совпадать.</p>

	<p>В ini‐файлах предусмотрены комментарии — это строки, начинающиеся с точки с запятой.</p>

	<p class="codebox"><span>Код</span>&#32;<span>INI‐файл</span><br /><code>
	<span class="inisection">[секция_1]</span><br />
	параметр1<span class="assignment">=</span>значение1<br />
	<span class="remark">; это комментарий</span><br />
	параметр2<span class="assignment">=</span>значение2<br />
	<br />
	<span class="inisection">[секция_2]</span><br />
	параметр1<span class="assignment">=</span>значение1<br />
	параметр2<span class="assignment">=</span>значение2
	</code></p>


	<h2><a id="c2">Функции для работы с ini‐файлами</a></h2>

	<p>Существуют специальные функции, предназначенные для чтения и записи INI-файлов, они лежат в библиотеке <strong>kernel32.dll</strong>:</p>
	<ul>
		<li><strong>GetPrivateProfileString</strong> — считывает строковое значение указанного параметра из указанного раздела;</li>
		<li><strong>GetPrivateProfileInt</strong> — считывает целочисленное значение указанного параметра из указанного раздела;</li>
		<li><strong>WritePrivateProfileString</strong> — записывает значение указанного параметра в указанный раздел указанного ini‐файла. Если указанного раздела или параметра не существует, то он будет создан. Если указанного ini-файла не существует, то он также будет создан.</li>
	</ul>

	<p>Эти функции работают со строками и существуют в двух вариантах: в ANSI‐версии и в юникодной версии, однако запись и чтение ini‐файлов в юникоде будет работать только если файл уже был ранее создан в юникоде (кодировка UTF-16 LE). То есть создать юникодный ini‐файл функцией WritePrivateProfileString нельзя, но можно создать сторонними программами, например, блокнотом.</p>


	<h3><a id="c2c1">GetPrivateProfileString</a></h3>

	<p>Получает строковое значение из INI‐файла.</p>

	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
	<span class="keyword">Declare</span> <span class="keyword">Function</span> GetPrivateProfileString <span class="keyword">Alias</span> <span class="string">&quot;GetPrivateProfileStringW&quot;</span>( _<br />
	&t;<span class="keyword">ByVal</span> lpAppName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpKeyName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpDefault <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpReturnedString <span class="keyword">As</span> <span class="datatype">LPWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> nSize <span class="keyword">As</span> <span class="datatype">DWORD</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpFileName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>) _<br />
	<span class="keyword">As</span> <span class="datatype">DWORD</span>
	</code></p>


	<h4>Параметры</h4>

	<dl>
	<dt>lpAppName</dt>
	<dd>Имя секции для получения параметра. Если этот параметр равен NULL, то функция возвратит все секции в файле.</dd>
	</dl>

	<dl>
	<dt>lpKeyName</dt>
	<dd>Имя ключа. Если этот параметр равен NULL, то функция возвратит все включи в данной секции.</dd>
	</dl>

	<dl>
	<dt>lpDefault</dt>
	<dd>Значение по умолчанию, которое возвратит функция, если ключ не будет найден.</dd>
	</dl>

	<dl>
	<dt>lpReturnedString</dt>
	<dd>Указатель на буфер (строку), куда функция запишет значение ключа.</dd>
	</dl>

	<dl>
	<dt>nSize</dt>
	<dd>Размер передаваемого в функцию буфера (размер выделенной памяти в символах под строку).</dd>
	</dl>

	<dl>
	<dt>lpFileName</dt>
	<dd>Имя ini‐файла. Если используется относительный путь к файлу, то считается, что он лежит в папке Windows.</dd>
	</dl>


	<h4>Возвращаемое значение</h4>

	<p>Функция возвращает количество скопированных символов в строку не включая нулевой символ. Для получения дополнительных сведений об ошибке можно вызвать функцию GetLastError.</p>


	<h3><a id="c2c2">GetPrivateProfileInt</a></h3>

	<p>Если значение в файле инициализации представлено числом, то его проще получить функцией GetPrivateProfileInt. Вот её определение из заголовочных файлов:</p>

	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
	<span class="keyword">Declare</span> <span class="keyword">Function</span> GetPrivateProfileInt <span class="keyword">Alias</span> <span class="string">&quot;GetPrivateProfileIntW&quot;</span>( _<br />
	&t;<span class="keyword">ByVal</span> lpAppName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpKeyName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpDefault <span class="keyword">As</span> <span class="datatype">INT_</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpFileName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>) _<br />
	<span class="keyword">As</span> <span class="datatype">UINT</span>
	</code></p>


	<h4>Параметры</h4>

	<dl>
	<dt>lpAppName</dt>
	<dd>Имя секции для получения параметра.</dd>
	</dl>

	<dl>
	<dt>lpKeyName</dt>
	<dd>Имя ключа.</dd>
	</dl>

	<dl>
	<dt>nDefault</dt>
	<dd>Значение по умолчанию, которое вернёт функция, если такового не будет в файле инициализации.</dd>
	</dl>

	<dl>
	<dt>lpFileName</dt>
	<dd>Имя INI‐файле. Если используется относительный путь к файлу, то считается, что он лежит в папке Windows.</dd>
	</dl>


	<h4>Возвращаемое значение</h4>

	<p>Функция возвращает число, представленное в INI‐файле.</p>


	<h3><a id="c2c3">WritePrivateProfileString</a></h3>

	<p>Записывает значение в ini‐файл, а если такового не было, то создаёт его.</p>

	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
	<span class="keyword">Declare</span> <span class="keyword">Function</span> WritePrivateProfileString <span class="keyword">Alias</span> <span class="string">&quot;WritePrivateProfileStringW&quot;</span>( _<br />
	&t;<span class="keyword">ByVal</span> lpAppName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpKeyName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpString <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>, _<br />
	&t;<span class="keyword">ByVal</span> lpFileName <span class="keyword">As</span> <span class="datatype">LPCWSTR</span>) _<br />
	<span class="keyword">As</span> <span class="datatype">WINBOOL</span>
	</code></p>


	<h4>Параметры</h4>

	<dl>
	<dt>lpAppName</dt>
	<dd>Имя секции для записи.</dd>
	</dl>

	<dl>
	<dt>lpKeyName</dt>
	<dd>Имя ключа. Если этот параметр будет равен NULL, то вся секция будет удалена.</dd>
	</dl>

	<dl>
	<dt>lpString</dt>
	<dd>Строка, которая будет записана как значение ключа. Если этот параметр равен NULL, то ключ будет удалён.</dd>
	</dl>

	<dl>
	<dt>lpFileName</dt>
	<dd>Имя ini‐файла. Если используется относительный путь к файлу, то считается, что он лежит в папке Windows.</dd>
	</dl>


	<h4>Возвращаемое значение</h4>

	<p>Если функция выполнилась успешно, то возвращаемое значение не ноль. При ошибке возвращаемое значение — ноль. Для получения дополнительных сведений об ошибке можно вызвать функцию GetLastError.</p>


	<h2><a id="c3">Примеры</a></h2>

	<p>Далее будут примеры использования с учётом юникода, а значит, программа будет корректно читать и записывать русские буквы.</p>

	<h3><a id="c3c1">Чтение файла</a></h3>

	<p>Создай в блокноте текстовый файл «configuration.ini» и сохрани его в кодировке Unicode (UTF-16):</p>

	<p class="codebox"><span>Код</span>&#32;<span>INI‐файл</span><br />
	<code><span class="inisection">[Окно]</span><br />
	<span class="remark">; Ширина и высота окна</span><br />
	Width<span class="assignment">=</span>640<br />
	Height<span class="assignment">=</span>480<br />
	<br />
	<span class="remark">; Параметры пользователя</span><br />
	<span class="inisection">[Пользователь]</span><br />
	Имя<span class="assignment">=</span>Алексей
	</code></p>

	<p>А теперь исходный код для чтения файла. Всё очень просто:</p>

	<p class="codebox"><span>Код</span>&#32;<span>FreeBASIC</span><br />
	<code>
	<span class="remark">&apos; Чтобы работать с юникодом</span><br />
	<span class="preprocessor">#define unicode</span><br />
	<span class="preprocessor">#include once &quot;windows.bi&quot;</span><br />
	<br />
	<span class="remark">&apos; Полный путь к файлу</span><br />
	<span class="keyword">Const</span> FileName = <span class="string">&quot;E:\Programming\FreeBASIC Projects\INI\configuration.ini&quot;</span><br />
	<span class="remark">&apos; Размер буфера</span><br />
	<span class="keyword">Const</span> BufferSize <span class="keyword">As</span> <span class="keyword">Integer</span> = 255<br />
	<span class="keyword">Const</span> SectionWindow = <span class="string">&quot;Окно&quot;</span><br /><span class="keyword">Const</span> KeyWidth = <span class="string">&quot;Width&quot;</span><br />
	<span class="keyword">Const</span> KeyHeight = <span class="string">&quot;Height&quot;</span><br /><span class="keyword">Const</span> DefaultValue = <span class="string">&quot;Значение по умолчанию&quot;</span><br />
	<br />
	<span class="remark">&apos; Значение из ini‐файла, которое мы получим</span><br />
	<span class="keyword">Dim</span> Value <span class="keyword">As</span> <span class="keyword">WString</span> * (BufferSize + 1) <span class="remark">&apos; Один символ под нулевой</span><br />
	<br />
	<span class="remark">&apos; Функция GetPrivateProfileString возвращает количество символов, скопированных в буфер (Value)</span><br />
	<span class="remark">&apos; Если раздел или ключ не будут найдены, то в Value будет записано содержимое DefaultValue</span><br />
	<span class="keyword">Dim</span> Result2 <span class="keyword">As</span> DWORD = GetPrivateProfileString(SectionWindow, KeyWidth, DefaultValue, Value, BufferSize, FileName)<br />
	<span class="keyword">If</span> Result2 &gt; 0 <span class="keyword">Then</span><br />
	&t;<span class="keyword">Print</span> KeyWidth, Value<br />
	<span class="keyword">End If</span><br />
	Result2 = GetPrivateProfileString(SectionWindow, KeyHeight, DefaultValue, Value, BufferSize, FileName)<br />
	<span class="keyword">If</span> Result2 &gt; 0 <span class="keyword">Then</span><br />
	&t;<span class="keyword">Print</span> KeyHeight, Value<br />
	<span class="keyword">End If</span>
	</code></p>

	<h3><a id="c3c2">Получение всех секций и ключей</a></h3>

	<p>Чтобы получить список всех секций, нужно в <strong>GetPrivateProfileString</strong> вместо имени секции передать Null. Функция заполнит возвращаемое значение Value строкой из всех разделов, разделённых символом с кодом 0. Аналогично для списка всех параметров в разделе: вместо имени требуемого параметра передать Null.</p>

	<p class="codebox"><span>Код</span>&#32;<span>FreeBASIC</span><br />
	<code>
	<span class="remark">&apos; Получение всех секций</span><br />
	<span class="keyword">Dim</span> Result2 <span class="keyword">As</span> DWORD = GetPrivateProfileString(Null, Null, DefaultValue, Value, BufferSize, FileName)<br />
	PrintResult(Value, Result2)<br />
	<br />
	<span class="remark">&apos; Получение всех ключей</span><br />
	Result2 = GetPrivateProfileString(SectionWindow, Null, DefaultValue, Value, BufferSize, FileName)<br />
	PrintResult(Value, Result2)<br />
	<br />
	<span class="remark">&apos; Печать результата</span><br />
	<span class="keyword">Sub</span> PrintResult(<span class="keyword">ByRef</span> Value <span class="keyword">As</span> <span class="keyword">WString</span>, <span class="keyword">ByVal</span> ValueLength <span class="keyword">As</span> <span class="keyword">Integer</span>)<br />
	&t;<span class="keyword">Dim</span> Start <span class="keyword">As</span> <span class="keyword">Integer</span> = 0<br />
	&t;<span class="keyword">Dim</span> w <span class="keyword">As</span> <span class="keyword">WString</span> <span class="keyword">Ptr</span> = <span class="keyword">Any</span><br />
	&t;<span class="keyword">Do</span> <span class="keyword">While</span> Start &lt; ValueLength<br />
	&t;&t;<span class="remark">&apos; Получить указатель на начало строки</span><br />
	&t;&t;w = @Value[Start]<br />
	&t;&t;<span class="remark">&apos; Распечатать</span><br />
	&t;&t;<span class="keyword">Print</span> *w<br />
	&t;&t;<span class="remark">&apos; Измерить длину строки, прибавить это к указателю + 1</span><br />
	&t;&t;Start += <span class="keyword">Len</span>(*w) + 1<br />
	&t;<span class="keyword">Loop</span><br />
	<span class="keyword">End Sub</span>
	</code></p>


	<h3><a id="c3c3">Запись в файл</a></h3>

	<p>Попробуем сменить имя пользователя:</p>

	<p class="codebox"><span>Код</span>&#32;<span>FreeBASIC</span><br />
	<code>
	<span class="keyword">Const</span> SectionUser = <span class="string">&quot;Пользователь&quot;</span><br />
	<span class="keyword">Const</span> KeyUser = <span class="string">&quot;Имя&quot;</span><br />
	<span class="keyword">Const</span> UserName = <span class="string">&quot;Саша&quot;</span><br />
	<br />
	<span class="remark">&apos; Функция возращает значение WinBool</span><br />
	<span class="keyword">Dim</span> Result <span class="keyword">As</span> <span class="keyword">WinBool</span> = WritePrivateProfileString(SectionUser, KeyUser, UserName, FileName)<br />
	<span class="keyword">If</span> Result <span class="keyword">Then</span><br />
	&t;<span class="keyword">Print</span> <span class="string">&quot;Запись удалась&quot;</span><br />
	<span class="keyword">End If</span>
	</code></p>


	<h3><a id="c3c4">Удаление раздела или параметра</a></h3>

	<p>Удаление — это запись NULL в ключ или раздел.</p>

	<p>Удалим параметр «Имя» из раздела «Пользователь»:</p>

	<p class="codebox"><span>Код</span>&#32;<span>FreeBASIC</span><br />

	<code>Result = WritePrivateProfileString(SectionUser, KeyUser, NULL, FileName)<br />
	<span class="keyword">If</span> Result <span class="keyword">Then</span><br />
	&t;<span class="keyword">Print</span> <span class="string">&quot;Удаление параметра успешно&quot;</span><br />
	<span class="keyword">End If</span>
	</code></p>

	<p>Точно также можно удалять целые секции из ini‐файлов:</p>

	<p class="codebox"><span>Код</span>&#32;<span>FreeBASIC</span><br />
	<code>Result = WritePrivateProfileString(SectionUser, NULL, NULL, FileName)<br />
	<span class="keyword">If</span> Result <span class="keyword">Then</span><br />
	&t;<span class="keyword">Print</span> <span class="string">&quot;Удаление секции успешно&quot;</span><br />
	<span class="keyword">End If</span>
	</code></p>

	<p>Не забываем сохранять исходный код в кодировке UTF-8 или UTF-16, а сам ini‐файл в юникоде (UTF-16).</p>

	<h2><a id="c4">Ссылки</a></h2>

	<ul>
		<li>Описание функции <strong>GetPrivateProfileString</strong> на сайте MSDN <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724353%28v=vs.85%29.aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/ms724353%28v=vs.85%29.aspx</a></li>
		<li>Описание функции <strong>WritePrivateProfileString</strong> на сайте MSDN <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms725501%28v=vs.85%29.aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/ms725501%28v=vs.85%29.aspx</a></li>
		<li>Недостатки INI‐файлов <a href="http://www.transl-gunsmoker.ru/2010/05/ini.html">http://www.transl-gunsmoker.ru/2010/05/ini.html</a></li>
	</ul>

	<h2>Поделись ссылочкой в социальных сетях</h2>
	<div id="vk_share_button"></div>


</main>


<hr />

<footer>
	<p>Сайт создан по технологии XHTML</p>
	<p>
		<span id="pLiveInternet"></span>
		<a href="http://wscatalog.ru/dir/programmirovanie-na-yazyke-freebasic" title="Сайт есть в Каталоге">
			<img width="88" height="31" src="http://wscatalog.ru/knopka.png" alt="Логотип wscatalog.ru" />
		</a>
		<a href="http://gluci.ru/dir/freebasic-na-russkom" title="Необычный Каталог Сайтов">
			<img width="88" height="31" src="http://gluci.ru/88x31.png" alt="Логотип Глюки" />
		</a> 
	</p>
</footer>

<script type="text/javascript" src="https://vk.com/js/api/share.js?93" charset="windows-1251"></script>
<script type="text/javascript">var docUrl=document.URL.toString();document.getElementById("vk_share_button").innerHTML=VK.Share.button(docUrl, {type: "round"});</script>


<script type="text/javascript">var idL=document.getElementById("pLiveInternet");var idA=document.createElement("a");idA.href="//www.liveinternet.ru/stat/freebasic.su";idA.title="Счётчик посещений LiveInternet";var idImg=document.createElement("img");idImg.src="//counter.yadro.ru/hit?t44."+Math.round(1+18*Math.random())+";r"+escape(document.referrer)+((typeof(screen)=="undefined")?"":";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?screen.colorDepth:screen.pixelDepth))+";u"+escape(docUrl)+";"+Math.random();idImg.alt="Логотип LiveInternet";idA.appendChild(idImg);idL.appendChild(idA);</script>

</body></html>