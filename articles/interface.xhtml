<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN" "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd"[

	<!ENTITY nbsp "&#160;">
	<!ENTITY t "&#160;&#160;&#160;&#160;">
	
]>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/1999/xhtml http://www.w3.org/MarkUp/SCHEMA/xhtml11.xsd" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

<head>
	<title>Интерфейсы простыми средствами</title>
	<meta name="description" content="Некоторые приёмы объектно‐ориентированного программирования: создание интерфейсов" />
	<meta name="keywords" content="Interface, наследование, реализация, виртуальная таблица методов, ООП" />
	
	<link href="/styles.css" type="text/css" rel="stylesheet" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	
</head>

<body>

<header>
	
	<nav>
		<p><a href="/">Главная</a></p>
		<p><a href="/articles/">Статьи</a></p>
		<p><a href="/projects/">Проекты</a></p>
		<p><a href="/books/">Учебник</a></p>
		<p><a href="/links.xhtml">Ссылки</a></p>
		<p><a href="/about.xhtml">О сайте</a></p>
	</nav>
	
</header>

<h1>Интерфейсы простыми средствами</h1>

<main>
	<p class="postername">
		<a href="/users/mabu.xhtml">
			<img src="/avatars/mabu.jpg" alt="Аватар пользователя" width="50" height="50" class="avatar" />
			&#32;
			mabu
		</a>
		&#32;
		<time pubdate="pubdate">2018-03-26T18:07:54+07:00</time>
	</p>
	
	<p>Для начала немного неточной терминологии.</p>
	
	<p><strong>Интерфейс</strong> — это набор функций, которые следует обязательно реализовать, то есть написать тело функций.</p>
	
	<p><strong>Наследование</strong> от интерфейса — это реализация набора функций.</p>
	
	<p><strong>Метод</strong> в объектно‐ориентированном программировании — это функция интерфейса.</p>
	
	<p><strong>Класс</strong> в объектно‐ориентированном программировании — это набор данных (структура), объединённый вместе с использующими эти данные функциями.</p>
	
	<p><strong>Объект</strong> — это переменная определённого класса или указатель на экземпляр таких данных (указатель на экземпляр структуры).</p>
	
	<p>Вот общие принципы организации интерфейсов:</p>
	
	<ul>
		<li>интерфейс только описывает функции (поведение) объекта, но не их реализацию;</li>
		<li>любой класс или структура, унаследованные от интерфейса, должны реализовать все его функции;</li>
		<li>экземпляр интерфейса не создают напрямую, вместо этого создают экземпляр класса (объект), унаследованный от интерфейса;</li>
		<li>интерфейсы содержат только функции, без переменных и констант;</li>
		<li>интерфейсы не содержат реализации (тела) методов;</li>
		<li>интерфейс может наследоваться от другого интерфейса, в таком случае производный класс реализует методы всех родительских интерфейсов;</li>
		<li>класс или структура может наследоваться от нескольких интерфейсов (множественное наследование).</li>
	</ul>
	
	<p>Во фрибейсике нет ключевого слова <code>Interface</code>, которое бы облегчало написание интерфейсов, но мы справимся с этой задачей и сами голыми руками. Для демонстрации серьёзности намерений напишем  какой‐нибудь бесполезный интерфейс, например, содержащий простые математические функции, и реализуем его.</p>
	
	<ol class="contents">
		<li><a href="#c1">Этапы построения интерфейса</a>
			<ol>
				<li><a href="#c1c1">Интерфейс как тип данных</a></li>
				<li><a href="#c1c2">Добавление контекста вызова</a></li>
				<li><a href="#c1c3">Таблица виртуальных методов</a></li>
				<li><a href="#c1c4">Разрешение циклических ссылок</a></li>
			</ol>
		</li>
		<li><a href="#c2">Наследование от интерфейса</a>
			<ol>
				<li><a href="#c2c1">Реализация функций</a></li>
				<li><a href="#c2c2">Таблица виртуальных методов</a></li>
				<li><a href="#c2c3">Класс, наследующий интерфейс</a></li>
				<li><a href="#c2c3">Создание объектов</a></li>
			</ol>
		</li>
		<li><a href="#c3">Пример интерфейса ICloneable для клонирования объектов</a>
			<ol>
				<li><a href="#c3c1">Интерфейс ICloneable</a></li>
				<li><a href="#c3c2">Класс Monster</a></li>
				<li><a href="#c3c3">Соединяем всё вместе</a></li>
			</ol>
		</li>
		<!-- <li><a href="#c4">Множественное наследование интерфейсов</a></li> -->
	</ol>
	
	<h2><a id="c1">Этапы построения интерфейса</a></h2>
	
	<p>Обычно имя интерфейса строится по правилу «I&lt;Имя&gt;», то есть состоит из написанного с заглавной буквы осмысленного имени, которому предшествует заглавная латинская буква I. Примеры: <code>IUnknown</code>, <code>IDispatch</code>, <code>IStringList</code> и тому подобное.</p>
	
	<h3><a id="c1c1">Интерфейс как тип данных</a></h3>
	
	<p>Определим набор функций для операций над двумя числами: сложение, вычитание, умножение, деление. Так как нам впоследствии необходимо будет использовать реальные функции, это значит, что такой набор должен состоять из указателей на наши будущие функции. Завернём их в структуру:</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="keyword">Type</span> <span class="datatype">IMath</span><br />
			&t;<span class="keyword">Dim</span> Add <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Substract <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Multiply <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Divide <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
		<span class="keyword">End Type</span>
	</code></p>
	
	<h3><a id="c1c2">Добавление контекста вызова</a></h3>
	
	<p>Чтобы функции интерфейса знали, какой объект их вызывает, придётся добавить в них указатель на объект, реализующий наш интерфейс, первым параметром:</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="keyword">Type</span> <span class="datatype">IMath</span><br />
			&t;<span class="keyword">Dim</span> Add <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Substract <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Multiply <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Divide <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
		<span class="keyword">End Type</span>
	</code></p>
	
	<h3><a id="c1c3">Таблица виртуальных методов</a></h3>
	
	<p>На практике набор функций интерфейса выделяют в отдельную структуру, которую теперь называеют таблицей виртуальных методов, а в самом интерфейсе оставляют ссылку (указатель) на неё. Это позволяет использовать одну и ту же таблицу для разных объектов одного класса, реализующих один и тот же интерфейс, экономя память. Название <code>VirtualTable</code> часто сокращают до <code>Vtable</code> или даже <code>Vtbl</code>, но мы будет использовать полный вариант.</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="keyword">Type</span> <span class="datatype">IMathVirtualTable</span><br />
			&t;<span class="keyword">Dim</span> Add <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Substract <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Multiply <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Divide <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
		<span class="keyword">End Type</span><br />
		<br />
		<span class="keyword">Type</span> <span class="datatype">IMath</span><br />
			&t;<span class="keyword">Dim</span> VirtualTable <span class="keyword">As</span> <span class="datatype">IMathVirtualTable Ptr</span><br />
		<span class="keyword">End Type</span>
	</code></p>
	
	<h3><a id="c1c4">Разрешение циклических ссылок</a></h3>
	
	<p>Пытаемся всё скомпилировать, но компилятор почему‐то сопротивляется такому коду. Дело в том, что виртуальная таблица <code>IMathVirtualTable</code> ссылается на интерфейс <code>IMath</code>, объявленный позднее, а интерфейс <code>IMath</code> ссылается на виртуальную таблицу <code>IMathVirtualTable</code>, и как их не меняй местами, ссылаться друг на друга от этого они не перестают. Выйти из ситуации поможет дополнительное имя для нашего интерфейса, введённое оператором <code>Type</code>, а к названию оригинального интерфейса добавим подчёркивание.</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="keyword">Type</span> <span class="datatype">IMath</span> <span class="keyword">As</span> <span class="datatype">IMath_</span><br />
		<br />
		<span class="keyword">Type</span> <span class="datatype">IMathVirtualTable</span><br />
			&t;<span class="keyword">Dim</span> Add <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Substract <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Multiply <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Dim</span> Divide <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
		<span class="keyword">End Type</span><br />
		<br />
		<span class="keyword">Type</span> <span class="datatype">IMath_</span><br />
			&t;<span class="keyword">Dim</span> VirtualTable <span class="keyword">As</span> <span class="datatype">IMathVirtualTable Ptr</span><br />
		<span class="keyword">End Type</span>
	</code></p>
	
	<p>Ну вот теперь‐то описание нашего интерфейса готово.</p>
	
	
	<h2><a id="c2">Наследование от интерфейса</a></h2>
	
	<p>Наследование от интерфейса есть его реализация в производном классе. Здесь нам нужно написать функции, создать таблицу и объявить класс‐наследник.</p>
	
	<h3><a id="c2c1">Реализация функций</a></h3>
	
	<p>Во всей этой мешанине виртуальных таблиц ты ещё не забыл, что интерфейс — это набор функций? Как раз пора приняться за них вплотную.</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="keyword">Function</span> Add( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Return</span> LeftOperand + RightOperand<br />
		<span class="keyword">End Function</span><br />
		<br />
		<span class="keyword">Function</span> Substract( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Return</span> LeftOperand - RightOperand<br />
		<span class="keyword">End Function</span><br />
		<br />
		<span class="keyword">Function</span> Multiply( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Return</span> LeftOperand * RightOperand<br />
		<span class="keyword">End Function</span><br />
		<br />
		<span class="keyword">Function</span> Divide( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">IMath Ptr</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> LeftOperand <span class="keyword">As</span> <span class="datatype">Integer</span>, _<br />
				&t;&t;<span class="keyword">ByVal</span> RightOperand <span class="keyword">As</span> <span class="datatype">Integer</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="keyword">Return</span> LeftOperand \ RightOperand<br />
		<span class="keyword">End Function</span>
	</code></p>
	
	<p>Параметр <code>this</code> представляет собой указатель на объект, который вызвал функцию интерфейса.</p>
	
	<h3><a id="c2c2">Таблица виртуальных методов</a></h3>
	
	<p>Создадим таблицу виртуальных функций класса <code>Math</code>, это требуется делать всего один раз вначале, так как она будет общая для всех производных объектов.</p>

	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="keyword">Dim Shared</span> GlobalMathVirtualTable <span class="keyword">As</span> <span class="datatype">IMathVirtualTable</span><br />
		GlobalMathVirtualTable.Add = @Add<br />
		GlobalMathVirtualTable.Substract = @Substract<br />
		GlobalMathVirtualTable.Multiply = @Multiply<br />
		GlobalMathVirtualTable.Divide = @Divide
	</code></p>
	
	<h3><a id="c2c3">Класс, наследующий интерфейс</a></h3>
	
	<p>Теперь объявим класс, наследующий наш интерфейс:</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="keyword">Type</span> <span class="datatype">Math</span><br />
			&t;<span class="keyword">Dim</span> VirtualTable <span class="keyword">As</span> <span class="datatype">IMathVirtualTable Ptr</span><br />
		<span class="keyword">End Type</span>
	</code></p>
	
	<p>Ты спросишь: почему здесь указана таблица виртуальных функций <code>IMathVirtualTable</code> вместо интерфейса <code>IMath</code>, если класс наследуется от <code>IMath</code>? Всё просто: все наследники интерфейса должны реализовывать все его методы, а сделать это можно объявив виртуальную таблицу функций этого интерфейса внутри класса.</p>
	
	
	<h3><a id="c2c4">Создание объектов</a></h3>
	
	<p>Вся прелесть интерфейсов в том, что какой бы ни был объект, но если он реализует наш интерфейс, то у него всегда будут требуемые нам методы. Вызывать методы можно через объект, унаследованный от требуемого интерфейса.</p>
	
	<p>Чтобы создать объект, требуется выделить под него память и назначить ему таблицу виртуальных функций:</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="remark">&apos; Выделяем память под объект, унаследованный от IMath</span><br />
		<span class="keyword">Dim</span> objMath <span class="keyword">As</span> <span class="datatype">IMath Ptr</span> = <span class="keyword">Allocate</span>(<span class="keyword">SizeOf</span>(<span class="datatype">Math</span>))<br />
		<br />
		<span class="remark">&apos; Обязательно проверяем на успешность выделения памяти</span><br />
		<span class="keyword">If</span> objMath = 0 <span class="keyword">Then</span><br />
			&t;<span class="keyword">Print</span> <span class="string">&quot;Не удалось выделить память под объект&quot;</span><br />
			&t;<span class="keyword">End</span>(1)<br />
		<span class="keyword">End If</span><br />
		<br />
		<span class="remark">&apos; Назначаем объекту таблицу виртуальных фукнций</span><br />
		objMath-&gt;VirtualTable = @GlobalMathVirtualTable
	</code></p>
	
	<p>Объект готов. Вызываем методы интерфейса у объекта:</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="keyword">Print</span> objMath-&gt;VirtualTable-&gt;Add(objMath, 3, 5)<br />
		<span class="keyword">Print</span> objMath-&gt;VirtualTable-&gt;Substract(objMath, 8, 4)<br />
		<span class="keyword">Print</span> objMath-&gt;VirtualTable-&gt;Multiply(objMath, 16, 5)<br />
		<span class="keyword">Print</span> objMath-&gt;VirtualTable-&gt;Divide(objMath, 9, 3)<br />
		<br />
		<span class="remark">&apos; Удаляем ненужные объекты</span><br />
		<span class="keyword">Deallocate</span>(objMath)
	</code></p>
	
	<p>Так как мы определили таблицу виртуальных функций явно, то код получился немного громоздким. В высокоуровневых языках программирования типа C++ эта таблица и контекст вызова существуют неявно и скрыто от программиста.</p>
	
	
	<h2><a id="c3">Пример интерфейса ICloneable для клонирования объектов</a></h2>
	
	<p>В компьютерных играх существуют специальные места, где монстры должны появляться регулярно. Такие логова монстров могут каждый раз создавать нового монстра, но гораздо выгоднее клонировать уже существующего как шаблон. В этом случае точке возрождения не нужно знать какой‐нибудь информации о монстре, достаточно запросить у самого монстра создать свою копию.</p>
	
	<h3><a id="c3c1">Интерфейс ICloneable</a></h3>
	
	<p>Интерфейс <code>ICloneable</code> предоставляет возможность объекту самому создавать собственную копию. Он должен содержать один метод <code>Clone</code>.</p>
	
	<p>Пример заголовочного файла <code>ICloneable.bi</code>:</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="preprocessor">#ifndef ICLONEABLE_BI</span><br />
		<span class="preprocessor">#define ICLONEABLE_BI</span><br />
		<br />
		<span class="keyword">Type</span> <span class="datatype">ICloneable</span> <span class="keyword">As</span> <span class="datatype">ICloneable_</span><br />
		<br />
		<span class="keyword">Type</span> <span class="datatype">ICloneableVirtualTable</span><br />
			&t;<span class="keyword">Dim</span> Clone <span class="keyword">As</span> <span class="datatype">Function</span>( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">ICloneable Ptr</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">ICloneable Ptr</span><br />
		<span class="keyword">End Type</span><br />
		<br />
		<span class="keyword">Type</span> <span class="datatype">ICloneable_</span><br />
			&t;<span class="keyword">Dim</span> VirtualTable <span class="keyword">As</span> <span class="datatype">ICloneableVirtualTable Ptr</span><br />
		<span class="keyword">End Type</span><br />
		<br />
		<span class="preprocessor">#endif</span>
	</code></p>
	
	<h3><a id="c3c2">Класс Monster</a></h3>
	
	<h4>Объявление</h4>
	
	<p>Теперь объявим класс <code>Monster</code> и унаследуем его от интерфейса <code>ICloneable</code> в заголовочном файле <code>Monster.bi</code>:</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="preprocessor">#ifndef MONSTER_BI</span><br />
		<span class="preprocessor">#define MONSTER_BI</span><br />
		<br />
		<span class="preprocessor">#include &quot;ICloneable.bi&quot;</span><br />
		<br />
		<span class="keyword">Type</span> <span class="datatype">Monster</span><br />
			&t;<span class="remark">&apos; Виртуальная таблица</span><br />
			&t;<span class="keyword">Dim</span> VirtualTable <span class="keyword">As</span> <span class="datatype">ICloneableVirtualTable Ptr</span><br />
			<br />
			&t;<span class="remark">&apos; Параметры монстра</span><br />
			<br />
			&t;<span class="remark">&apos; Координаты на игровом поле</span><br />
			&t;<span class="keyword">Dim</span> X <span class="keyword">As</span> <span class="datatype">Integer</span><br />
			&t;<span class="keyword">Dim</span> Y <span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="remark">&apos; Сила удара монстра</span><br />
			&t;<span class="keyword">Dim</span> Power <span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="remark">&apos; Здоровье монстра</span><br />
			&t;<span class="keyword">Dim</span> Health <span class="keyword">As</span> <span class="datatype">Integer</span><br />
			<br />
			&t;<span class="remark">&apos; Отображаемое имя</span><br />
			&t;<span class="keyword">Dim</span> CharacterName <span class="keyword">As</span> <span class="datatype">WString Ptr</span><br />
		<span class="keyword">End Type</span><br />
		<br />
		<span class="keyword">Declare</span> <span class="keyword">Function</span> Clone( _<br />
			&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">Monster Ptr</span> _<br />
		)<span class="keyword">As</span> <span class="datatype">Monster Ptr</span><br />
		<br />
		<span class="preprocessor">#endif</span>
	</code></p>
	
	<h4>Реализация</h4>
	
	<p>Посмотрим на реализацию клонирования монстра в файле <code>Monster.bas</code>:</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="preprocessor">#include &quot;Monster.bi&quot;</span><br />
		<br />
		<span class="keyword">Function</span> Clone( _<br />
				&t;&t;<span class="keyword">ByVal</span> this <span class="keyword">As</span> <span class="datatype">Monster Ptr</span> _<br />
			&t;)<span class="keyword">As</span> <span class="datatype">Monster Ptr</span><br />
			<br />
			&t;<span class="remark">&apos; Выделяем память под монстра</span><br />
			&t;<span class="keyword">Dim</span> pMonster <span class="keyword">As</span> <span class="datatype">Monster Ptr</span> = <span class="keyword">Allocate</span>(<span class="keyword">SizeOf</span>(<span class="datatype">Monster</span>))<br />
			&t;<span class="keyword">If</span> pMonster = 0 <span class="keyword">Then</span><br />
				&t;&t;<span class="keyword">Return</span> 0<br />
			&t;<span class="keyword">End If</span><br />
			<br />
			&t;<span class="remark">&apos; Клонирование имени монстра</span><br />
			&t;<span class="keyword">Dim</span> CharacterNameLength <span class="keyword">As</span> <span class="datatype">Integer</span> = <span class="keyword">Len</span>(*this-&gt;CharacterName)<br />
			&t;<span class="keyword">Dim</span> pCharacterName <span class="keyword">As</span> <span class="datatype">WString Ptr</span> = <span class="keyword">Allocate</span>((CharacterNameLength + 1) * <span class="keyword">SizeOf</span>(<span class="datatype">WString</span>))<br />
			&t;<span class="keyword">If</span> pCharacterName = 0 <span class="keyword">Then</span><br />
				&t;&t;<span class="keyword">Deallocate</span>(pMonster)<br />
				&t;&t;<span class="keyword">Return</span> 0<br />
			&t;<span class="keyword">End If</span><br />
			&t;*pCharacterName = *this-&gt;CharacterName<br />
			<br />
			&t;<span class="remark">&apos; Клонирование самих себя</span><br />
			&t;pMonster-&gt;VirtualTable = this-&gt;VirtualTable<br />
			&t;pMonster-&gt;X = this-&gt;X<br />
			&t;pMonster-&gt;Y = this-&gt;Y<br />
			&t;pMonster-&gt;Power = this-&gt;Power<br />
			&t;pMonster-&gt;Health = this-&gt;Health<br />
			&t;pMonster-&gt;CharacterName = pCharacterName<br />
			<br />
			&t;<span class="keyword">Return</span> pMonster<br />
		<span class="keyword">End Function</span>
	</code></p>
	
	<h3><a id="c3c3">Соединяем всё вместе</a></h3>
	
	<p>В этом примере создадим десять клонированных монстров на основе уже существующего.</p>
	
	<p class="codebox"><span>Код</span> <span>FreeBASIC</span><br /><code>
		<span class="preprocessor">#include &quot;ICloneable.bi&quot;</span><br />
		<span class="preprocessor">#include &quot;Monster.bi&quot;</span><br />
		<br />
		<span class="remark">&apos; Виртуальная таблица функций монстра</span><br />
		<span class="keyword">Dim</span> <span class="keyword">Shared</span> GlobalMonsterVirtualTable <span class="keyword">As</span> <span class="datatype">ICloneableVirtualTable</span><br />
		GlobalMonsterVirtualTable.Clone = <span class="keyword">CPtr</span>(<span class="datatype">Any Ptr</span>, @Clone)<br />
		<br />
		<span class="remark">&apos; Шаблон монстра для клонирования</span><br />
		<span class="keyword">Dim</span> objMainMonster <span class="keyword">As</span> <span class="datatype">Monster Ptr</span> = <span class="keyword">Allocate</span>(<span class="keyword">SizeOf</span>(<span class="datatype">Monster</span>))<br />
		<br />
		<span class="remark">&apos; Обязательно проверяем на успешность выделения памяти</span><br />
		<span class="keyword">If</span> objMainMonster = 0 <span class="keyword">Then</span><br />
			&t;<span class="keyword">Print</span> <span class="string">&quot;Не удалось выделить память под объект&quot;</span><br />
			&t;<span class="keyword">End</span>(1)<br />
		<span class="keyword">End If</span><br />
		<br />
		<span class="remark">&apos; Назначаем объекту таблицу виртуальных фукнций</span><br />
		objMainMonster-&gt;VirtualTable = @GlobalMonsterVirtualTable<br />
		<br />
		<span class="remark">&apos; Параметры монстра</span><br />
		objMainMonster-&gt;X = 25<br />
		objMainMonster-&gt;Y = 40<br />
		objMainMonster-&gt;Power = 67<br />
		objMainMonster-&gt;Health = 100<br />
		objMainMonster-&gt;CharacterName = @<span class="string">&quot;Ужасный маленький монстр&quot;</span><br />
		<br />
		<span class="remark">&apos; Десять дополнительных клонов</span><br />
		<span class="keyword">Dim</span> Clones(9) <span class="keyword">As</span> <span class="datatype">ICloneable Ptr</span><br />
		<span class="keyword">For</span> i <span class="keyword">As</span> <span class="datatype">Integer</span> = 0 <span class="keyword">To</span> 9<br />
			&t;Clones(i) = <span class="keyword">CPtr</span>(<span class="datatype">ICloneable Ptr</span>, objMainMonster-&gt;VirtualTable-&gt;Clone(<span class="keyword">CPtr</span>(<span class="datatype">ICloneable Ptr</span>, objMainMonster)))<br />
		<span class="keyword">Next</span><br />
		<br />
		<span class="remark">&apos; Проверяем работоспособность клонов</span><br />
		<span class="keyword">For</span> i <span class="keyword">As</span> <span class="datatype">Integer</span> = 0 <span class="keyword">To</span> 9<br />
			&t;<span class="keyword">Dim</span> pMonster <span class="keyword">As</span> <span class="datatype">Monster Ptr</span> = <span class="keyword">CPtr</span>(<span class="datatype">Monster Ptr</span>, Clones(i))<br />
			&t;<span class="keyword">Print</span> pMonster-&gt;X,<br />
			&t;<span class="keyword">Print</span> pMonster-&gt;Y,<br />
			&t;<span class="keyword">Print</span> pMonster-&gt;Power,<br />
			&t;<span class="keyword">Print</span> pMonster-&gt;Health,<br />
			&t;<span class="keyword">Print</span> *pMonster-&gt;CharacterName<br />
		<span class="keyword">Next</span><br />
		<br />
		<span class="remark">&apos; Удаляем клонов</span><br />
		<span class="keyword">For</span> i <span class="keyword">As</span> <span class="datatype">Integer</span> = 0 <span class="keyword">To</span> 9<br />
			&t;<span class="keyword">Dim</span> pMonster <span class="keyword">As</span> <span class="datatype">Monster Ptr</span> = <span class="keyword">CPtr</span>(<span class="datatype">Monster Ptr</span>, Clones(i))<br />
			&t;<span class="keyword">Deallocate</span>(pMonster-&gt;CharacterName)<br />
			&t;<span class="keyword">Deallocate</span>(pMonster)<br />
		<span class="keyword">Next</span><br />
		<br />
		<span class="remark">&apos; Удаляем шаблонный объект</span><br />
		<span class="keyword">Deallocate</span>(objMainMonster)
	</code></p>
	
	<p>Можно видеть, что клонирование не зависит от типа объекта. Это могут быть разные монстры, предметы, оружие. Клонировать можно что угодно, если оно реализует интерфейс <code>ICloneable</code>.</p>
	
	<!--
	<h2><a id="c4">Множественное наследование интерфейсов</a></h2>
	
	<p>Множественное наследование позволяет объекту мимикрировать под разные договорённости о поведении. В исходном коде это реализуется добавлением в базовый класс нескольких таблиц виртуальных функций.</p>
	
	<p>Рассмотрим множественное наследование на примере </p>
	-->
	
	<h2>Поделись ссылочкой в социальных сетях</h2>
	<div id="vk_share_button"></div>
	
</main>

<hr />

<footer>
	<p>Сайт создан по технологии XHTML</p>
	<p>
		<span id="pLiveInternet"></span>
		<a href="http://wscatalog.ru/dir/programmirovanie-na-yazyke-freebasic" title="Сайт есть в Каталоге">
			<img width="88" height="31" src="http://wscatalog.ru/knopka.png" alt="Логотип wscatalog.ru" />
		</a>
		<a href="http://gluci.ru/dir/freebasic-na-russkom" title="Необычный Каталог Сайтов">
			<img width="88" height="31" src="http://gluci.ru/88x31.png" alt="Логотип Глюки" />
		</a> 
	</p>
</footer>

<script type="text/javascript" src="https://vk.com/js/api/share.js?93" charset="windows-1251"></script>
<script type="text/javascript">var docUrl=document.URL.toString();document.getElementById("vk_share_button").innerHTML=VK.Share.button(docUrl, {type: "round"});</script>


<script type="text/javascript">var idL=document.getElementById("pLiveInternet");var idA=document.createElement("a");idA.href="//www.liveinternet.ru/stat/freebasic.su";idA.title="Счётчик посещений LiveInternet";var idImg=document.createElement("img");idImg.src="//counter.yadro.ru/hit?t44."+Math.round(1+18*Math.random())+";r"+escape(document.referrer)+((typeof(screen)=="undefined")?"":";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?screen.colorDepth:screen.pixelDepth))+";u"+escape(docUrl)+";"+Math.random();idImg.alt="Логотип LiveInternet";idA.appendChild(idImg);idL.appendChild(idA);</script>

</body></html>